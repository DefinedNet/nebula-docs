---
title: Upgrading a Nebula network to IPv6 overlay addresses
summary:
  This guide describes how to upgrade an existing nebula network to the v2 certificate format and enable IPv6 addresses.
---

# Upgrading a Nebula network to IPv6 overlay addresses

Nebula v1.10 adds support for IPv6-addressed Nebula hosts. To support the feature, Nebula has upgraded to a v2
certificate format. While v1 certificates support only a single IPv4 address for a given host, the v2 format allows
multiple IPv4 and/or IPv6 addresses. In this guide we will describe how to upgrade a network to the v2 certificate
format with IPv6 support using a dual-CA migration strategy.

The dual-CA approach allows for a smooth transition by running both v1 and v2 certificates simultaneously during the
migration, signed by separate certificate authorities. This provides a clear upgrade path with easy rollback capability.

The basic steps are:

import TOCInline from '@theme/TOCInline';

<TOCInline toc={toc} />

## Upgrade Nebula

First, update each host in your network to Nebula v1.10 or later with support for v2 certificates.

- [https://github.com/slackhq/nebula/releases](https://github.com/slackhq/nebula/releases)
- [https://hub.docker.com/r/nebulaoss/nebula](https://hub.docker.com/r/nebulaoss/nebula)
- [https://github.com/NebulaOSS/nebula-nightly/releases](https://github.com/NebulaOSS/nebula-nightly/releases)
- [https://hub.docker.com/r/nebulaoss/nebula-nightly](https://hub.docker.com/r/nebulaoss/nebula-nightly)

## Create a new v2 Certificate Authority

Create a new v2 Certificate Authority that will coexist with your existing v1 CA during the migration. Creating a new CA
with Nebula v1.10 will create a v2 CA by default.

```bash
❯ nebula-cert ca -name "My Nebula CA v2" -encrypt
Enter passphrase:
```

Using `nebula-cert print` we can verify this is a v2 certificate authority:

```bash
❯ nebula-cert print -path ./ca.crt
{
        "curve": "CURVE25519",
        "details": {
                "groups": null,
                "isCa": true,
                "issuer": "",
                "name": "My Nebula CA v2",
                "networks": null,
                "notAfter": "2026-12-08T17:05:37-06:00",
                "notBefore": "2025-12-08T17:05:37-06:00",
                "unsafeNetworks": null
        },
        "fingerprint": "59221e34fca969fe913e0edc8b73d8411620cfacb9b8c30378d590c7e3a39911",
        "publicKey": "fda276829fe4f1f1d6ee49dc9ebd6ded9a38d129bebd24d7f0381c28da397d34",
        "signature": "419255b7f7491ffc2c957b936425fca24571c8efb4416f247dc04084061f37f4891e8e16ad67941ff59bc0bbf55c1f69528b8d1c02876c66fdb7c061694d3f09",
        "version": 2
}
```

## Add the v2 CA to the trust bundle

Append the new v2 CA certificate to the [`pki.ca` trust bundle](https://nebula.defined.net/docs/config/pki/#pkica) in
the config of every Nebula host. This allows hosts to trust certificates signed by both the old v1 CA and the new v2 CA.

```yaml
pki:
  ca: |
    # Original v1 CA certificate
    -----BEGIN NEBULA CERTIFICATE-----
    [your existing v1 CA certificate content]
    -----END NEBULA CERTIFICATE-----
    # New v2 CA certificate
    -----BEGIN NEBULA CERTIFICATE-----
    [your new v2 CA certificate content]
    -----END NEBULA CERTIFICATE-----
```

After updating the trust bundle, **reload** Nebula on all hosts. At this point, hosts can validate certificates from
either CA, but are still using their v1 certificates.

## Issue v2 certificates for all hosts

Using the new v2 CA, create v2 certificates for each host. A v2 CA creates v2 certificates by default:

```bash
❯ nebula-cert sign -ca-crt ca.crt -ca-key ca.key -name "host-1" -networks "192.168.1.1/24"
Enter passphrase:
```

If you want to add IPv6 addresses at this stage, you can do so:

```bash
❯ nebula-cert sign -ca-crt ca.crt -ca-key ca.key -name "host-1" -networks "192.168.1.1/24,fdc8:d0db:a315:cb00::1/64"
Enter passphrase:
```

Verify the certificate is v2:

```bash
nebula-cert print -path host-1.crt
{
       "curve": "CURVE25519",
       "details": {
               "groups": null,
               "isCa": false,
               "issuer": "59221e34fca969fe913e0edc8b73d8411620cfacb9b8c30378d590c7e3a39911",
               "name": "host-1",
               "networks": [
                       "192.168.1.1/24",
                       "fdc8:d0db:a315:cb00::1/64"
               ],
               "notAfter": "2026-12-08T17:05:36-06:00",
               "notBefore": "2025-12-08T17:07:37-06:00",
               "unsafeNetworks": null
       },
       "fingerprint": "673a36f22efc6716b61f28fc532a1cc1b74131264f76ebf06c59c7e4b13df1da",
       "publicKey": "2a93840b9b1f9cdec3efddbcb35ec2190f86b8478f278a5ade03373984414408",
       "signature": "05f7b249e46d35e3d072a5eec425c76f12d12b34ef18376e513038395d224ff0b4b13beb50c30547fccf1344e197c2b4e316c483e4e6921f11bbb66dc646d008",
       "version": 2
}
```

## Roll out v2 certificates to hosts

Now update each host with its new v2 certificate. Update the
[`pki.cert`](https://nebula.defined.net/docs/config/pki/#pkicert) and
[`pki.key`](https://nebula.defined.net/docs/config/pki/#pkikey) fields with the new v2 certificate and key.

Additionally, set the [`pki.initiating_version`](https://nebula.defined.net/docs/config/pki/#pkiinitiating_version) to 2
to ensure the host uses v2 certificates when initiating handshakes:

```yaml
pki:
  ca: |
    # Both CAs remain in the trust bundle
    -----BEGIN NEBULA CERTIFICATE-----
    [v1 CA certificate]
    -----END NEBULA CERTIFICATE-----
    -----BEGIN NEBULA CERTIFICATE-----
    [v2 CA certificate]
    -----END NEBULA CERTIFICATE-----
  cert: |
    # New v2 certificate only
    -----BEGIN NEBULA CERTIFICATE-----
    [v2 certificate content]
    -----END NEBULA CERTIFICATE-----
  key: |
    # New v2 private key
    -----BEGIN NEBULA ED25519 PRIVATE KEY-----
    [v2 private key content]
    -----END NEBULA ED25519 PRIVATE KEY-----
  initiating_version: 2
```

After updating, **restart** Nebula. The host will now use its v2 certificate for all connections.

:::tip

Roll this change out gradually, starting with a small subset of hosts. Verify connectivity between upgraded and
non-upgraded hosts before proceeding with the full rollout. Since all hosts trust both CAs, v1 and v2 hosts can
communicate during the migration period.

:::

## Verify v2 certificates are in use

After updating a host, you can verify it's using v2 certificates via the `print-tunnel` command from the
[debug SSH server](/docs/guides/debug-ssh-commands/):

```bash
steve@nebula > print-tunnel 192.168.1.2
{
  "vpnAddrs": [
    "192.168.1.2"
  ],
  "localIndex": 2965094606,
  "remoteIndex": 1285130098,
  "remoteAddrs": [
    "172.17.0.3:4242"
  ],
  "cert": {
    "details": {
      "curve": "CURVE25519",
      "groups": [],
      "isCa": false,
      "issuer": "b9e1dd7394a8750c38cda2fe4349616dc494dad8e645a37b25957e11dd7e3b4e",
      "name": "lighthouse1",
      "networks": [
        "192.168.1.2/24",
        "fdc8:d0db:a315:cb00::2/64"
      ],
      "notAfter": "2026-03-11T17:26:18Z",
      "notBefore": "2025-03-18T17:14:43Z",
      "publicKey": "c455bc023b1b3918538edf5f230169df12603703639db158c76da747e0eccc47",
      "unsafeNetworks": []
    },
    "fingerprint": "84cf960de2e49f7560a5c7f876857528f02ab201c906f5a094d0d3294732b655",
    "signature": "6b9e98e398fb4c6a89f8e71e6a1378cecb85c500966443673a3ebe8f9d46702d0213dbd4c5028644104eeae49c06a4906058b53cd809e07dec76fcec60a4370d",
    "version": 2
  },
  "messageCounter": 3,
  "currentRemote": "172.17.0.3:4242",
  "currentRelaysToMe": [],
  "currentRelaysThroughMe": []
}
```

You can also check the logs for the `certVersion` field in handshakes:

```bash
time="2025-03-27T16:50:26-05:00" level=info msg="Handshake message received" certName=lighthouse1 certVersion=2 durationNs=63460958 fingerprint=84cf960de2e49f7560a5c7f876857528f02ab201c906f5a094d0d3294732b655 handshake="map[stage:2 style:ix_psk0]" initiatorIndex=530355834 issuer=b9e1dd7394a8750c38cda2fe4349616dc494dad8e645a37b25957e11dd7e3b4e remoteIndex=530355834 responderIndex=3163624101 sentCachedPackets=1 udpAddr="172.17.0.3:4242" vpnAddrs="[192.168.1.2]"
```

## Clean up the v1 CA

Once all hosts have been migrated to v2 certificates and you've verified the network is stable:

1. Remove the v1 CA certificate from the `pki.ca` trust bundle on all hosts
2. Remove any backup files containing v1 certificates and keys
3. **Reload** Nebula on all hosts

Your network is now fully migrated to v2 certificates with IPv6 support.

## IPv6 considerations

With v2 certificates supporting multiple addresses, you have several options:

- **Dual-stack**: Keep both IPv4 and IPv6 addresses for maximum compatibility
- **IPv6-only**: Transition fully to IPv6 by removing IPv4 addresses from certificates
- **Gradual transition**: Start with dual-stack and gradually phase out IPv4

If moving to IPv6-only, remember to:

- Update your `static_host_map` to use IPv6 overlay addresses
- Ensure your underlying network infrastructure supports IPv6
- Update any firewall rules or security groups to allow IPv6 traffic
- Test connectivity thoroughly before removing IPv4 support

### Example static_host_map configurations

**Original IPv4-only configuration:**

```yaml
static_host_map:
  '192.168.1.2': ['lighthouse.example.com:4242']
```

**Dual-stack configuration (both IPv4 and IPv6 overlay addresses):**

```yaml
static_host_map:
  '192.168.1.2': ['lighthouse.example.com:4242']
  'fdc8:d0db:a315:cb00::2': ['lighthouse.example.com:4242']
```

**IPv6-only configuration:**

```yaml
static_host_map:
  'fdc8:d0db:a315:cb00::2': ['lighthouse.example.com:4242']
```

Note that the left side of `static_host_map` is the Nebula overlay address (IPv4 or IPv6), while the right side remains
the physical underlay address where the lighthouse can be reached.

## Rollback procedure

If issues arise during migration, you can rollback by:

1. If only some hosts are upgraded: Simply restart the affected hosts with their original v1 certificates
2. If all hosts are upgraded but experiencing issues:
   - Keep both CAs in the trust bundle
   - Revert the `pki.cert` and `pki.key` fields to the v1 certificates
   - Remove or set `pki.initiating_version` to 1
   - Restart Nebula

The dual-CA approach ensures hosts can communicate regardless of which certificate version they're using, as long as
both CAs remain in the trust bundle during the migration period.
