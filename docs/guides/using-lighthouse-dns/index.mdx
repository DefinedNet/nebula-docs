# Using Experimental Lighthouse DNS with Nebula

:::caution

Lighthouse DNS in Nebula is Experimental and not intended to be a robust solution currently.

:::

Nebula comes with built-in DNS server support in the Lighthouse hosts.

Lighthouse DNS can be helpful and useful for generating DNS records based on dynamic nebula hosts, for example if you
are spinning up new nebula hosts with demand, or using [anycast](https://en.wikipedia.org/wiki/Anycast) addresses to
split load.

An alternative approach to DNS would be to point public DNS records at private nebula IP addresses. If you want to, you
can simply create a public DNS A record pointing to `10.0.0.23` for your private team wiki on <https://gandi.net> or
some other public DNS, set up a server w/ TLS and Basic Auth via
[caddy server](https://caddyserver.com/docs/getting-started), and you're golden.

To get started, set up a lighthouse and two hosts using our [Quick Start](/docs/guides/quick-start/).

You can then use [`lighthouse.serve_dns`](/docs/config/lighthouse#lighthouseserve_dns) and the
[`lighthouse.dns`](/docs/config/lighthouse#lighthousedns) config settings for your lighthouse config file to enable DNS
querying.

You'll then want to set up the lighthouse as a DNS server for the other two hosts. This can be either the public static
lighthouse IP or the private Nebula IP. If you set `lighthouse.dns.host: [::]`, it will bind to all interfaces,
including both the public and Nebula IP. Binding to only the Nebula IP, for example `lighthouse.dns.host: 10.0.0.1` will
ensure the DNS is only accessible to hosts that are allowed to make UDP requests to that lighthouse.

## Q&A

- How do hostnames turn into DNS host names?
  - If the hostname is a valid DNS name, it will be resolved by the Lighthouse DNS resolver.
- Are the domain names case-sensitive?
  - Currently the DNS server matches names case sensitively, though DNS is
    [meant to resolve case-insensitively](https://www.rfc-editor.org/rfc/rfc1035#section-2.3.3).
- Do they support Unicode?
  - I don't think so? Maybe via punycode???
- How do duplicate hostnames get resolved?
- Can I run more than one Lighthouse DNS server?
  - Sure. Just set as many lighthouses as you want in your DNS query settings for your host.
- How to get the lighthouse to answer questions about itself
  - How does the lighthouse learn about hosts? Hosts connect to the lighthouse as they normally do, and in doing so the
    lighthouse learns about their cert. Due to this fact, the lighthouse can only answer questions about hosts it has
    seen since last start.

## How to name hosts w/ valid domain names

https://www.geeksforgeeks.org/how-to-validate-a-domain-name-using-regular-expression/

Here's a validator inline in the documentation for you:

import { ValidateDomainInput } from './ValidateDomainInput';

<ValidateDomainInput />

## Tutorial

First, spin up a lighthouse and 2 hosts. Then add

```yaml
lighthouse:
  serve_dns: true
  host: [::]
  port: 53
```

to your config for your lighthouse as well as a firewall rule that enables UDP on port `53` for all hosts you want to
query DNS on the lighthouse.

Then you can run `dig` against it to test! For example, I made a host named `lighthouse` as my lighthouse with nebula IP
`100.100.0.1` and `alice-laptop` with nebula IP `100.100.0.2` as my host, and I set up my lighthouse with the above
config / firewall rule.

```bash
dig @100.100.0.1 +short alice-laptop A
100.100.0.2
```

I can also query the TXT record for the nebula IP for certificate info. Each piece of info is delivered within quotes
and as a `"Key: Value"` format.

```bash
dig @100.100.0.1 +short "100.100.0.2" TXT
"Name: alice-laptop" "Ips: [100.100.0.2/22]" "Subnets []" "Groups [role:Laptop]" "NotBefore 2022-12-06 21:34:25 +0000 UTC" "NotAFter 2024-05-13 17:37:27 +0000 UTC" "PublicKey 2c4828672fef1306124df94eb0fecd753e462e1bd4107f866f4e1a463550eb1b" "IsCA false" "Issuer 5b568aedaa5d97746e870f01a356ba474cf3251c0e743499ec668f93efa77f51"
```

If I then host a server on `[::]:3000` on `alice-laptop` and set up a firewall rule that allows this to be accessed from
`bob-laptop`, I can request it with `curl` using the custom DNS resolver.

```bash
curl --dns-servers "100.100.0.1" http://alice-laptop:3000
<div>hello i am a website</div>
```
