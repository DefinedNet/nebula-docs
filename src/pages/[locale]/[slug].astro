---
import Layout from '../../layouts/MainLayout.astro';
import {getLanguageFromFilename, getSlugFromFilename} from '../../languages';

export async function getStaticPaths() {
  /**
   * This builds up a set of params using the filename (which is always in english) as the slug,
   * and adds a redirect prop to the proper internationalized slug.
   */
  function getRedirects(allPages) {
    return allPages
      .map(({ astro, url, file, ...page }) => {
        const slug = getSlugFromFilename(file.pathname);
        const locale = getLanguageFromFilename(file.pathname);

        return {
          params: {
            locale,
            slug
          },
          props: {
            redirect: `/${locale}/${page.slug}`,
          }
        }
      })
  }

  const allPages = Astro.fetchContent('../../data/docs/**/*.md');

  const redirects = getRedirects(allPages);

  const paths = allPages.map(({ astro, url, file, ...page }) => {
    const locale = getLanguageFromFilename(file.pathname);
    
    return {
      params: {
        locale: locale,
        slug: page.slug
      },
      props: {
        page: {
          ...page,
          html: astro.html
        }
      }
    }
  })

  return [...paths, ...redirects].filter(({ params }) => !!params.slug);
}

const { page, redirect } = Astro.props
---

{redirect 
  ? <head><meta http-equiv="refresh" content={`0; url=${redirect}`}></head>
  : <Layout content={page}>
      {page.html}
    </Layout>
}
